## 트리셰이킹 (Tree Shaking)

트리셰이킹(Tree Shaking)은 사용하지 않는 코드를 자동으로 제거하여 번들 크기를 줄이는 최적화 기법이에요. 마치 나무를 흔들어 죽은 잎사귀를 떨어뜨리는 것처럼, 사용되지 않는 코드를 제거한다고 해서 트리셰이킹이라는 이름이 붙었어요.

## 트리셰이킹이 필요한 이유

라이브러리나 모듈에서 일부 기능만 사용하는 경우가 많아요. 하지만 트리셰이킹이 없다면 사용하지 않는 코드까지 모두 번들에 포함돼요.

예를 들어, Lodash에서 `debounce` 함수 하나만 사용하는데도 전체 라이브러리가 번들에 포함되면 불필요하게 번들 크기가 커져요.

```js
// 전체 Lodash 임포트 (좋지 않음)
import _ from 'lodash';
const debounced = _.debounce(fn, 300);

// 필요한 함수만 임포트 (좋음)
import { debounce } from 'lodash-es';
const debounced = debounce(fn, 300);
```

## 트리셰이킹 동작 조건

트리셰이킹이 제대로 작동하려면 다음 조건을 만족해야 해요:

### 1. ES6 모듈 사용하기

트리셰이킹은 ES6 모듈(`import`/`export`)의 정적 구조를 분석해서 동작해요. CommonJS(`require`/`module.exports`)는 동적이라서 트리셰이킹이 불가능해요.

```js
// ✅ 트리셰이킹 가능 (ES6 모듈)
import { add } from './math';

// ❌ 트리셰이킹 불가능 (CommonJS)
const { add } = require('./math');
```

### 2. 프로덕션 모드 사용하기

웹팩에서 트리셰이킹을 활성화하려면 프로덕션 모드로 빌드해야 해요.

```js
// webpack.config.js
module.exports = {
  mode: 'production', // 트리셰이킹 자동 활성화
};
```

### 3. 사이드 이펙트 표시하기

모듈이 부수 효과(Side Effect)가 없다는 것을 명시해야 해요.

```json
// package.json
{
  "name": "my-library",
  "sideEffects": false
}
```

## 사이드 이펙트(Side Effects)

사이드 이펙트는 파일을 임포트할 때 전역 상태를 변경하거나 특정 동작을 수행하는 코드예요.

### 사이드 이펙트가 있는 코드

```js
// polyfill.js (사이드 이펙트 있음)
window.Promise = MyPromisePolyfill;

// analytics.js (사이드 이펙트 있음)
console.log('Analytics initialized');
window.analytics = initAnalytics();
```

이런 파일들은 임포트하는 것만으로도 전역 상태가 변경되므로, 사용하지 않더라도 제거하면 안 돼요.

### 사이드 이펙트가 없는 코드

```js
// math.js (사이드 이펙트 없음)
export function add(a, b) {
  return a + b;
}

export function subtract(a, b) {
  return a - b;
}
```

이런 순수 함수들은 임포트해도 전역 상태가 변하지 않으므로, 사용하지 않는 함수는 안전하게 제거할 수 있어요.

## package.json에서 사이드 이펙트 설정하기

### 모든 파일이 사이드 이펙트 없음

```json
{
  "sideEffects": false
}
```

### 특정 파일만 사이드 이펙트 있음

```json
{
  "sideEffects": ["*.css", "*.scss", "./src/polyfills.js"]
}
```

CSS 파일은 임포트하는 것 자체가 스타일을 적용하는 사이드 이펙트이므로, 반드시 명시해야 해요.

## 실제 예제

### 라이브러리 제작자 입장

```js
// src/index.js
export { add, subtract } from './math';
export { formatDate } from './date';
export { debounce, throttle } from './utils';
```

```json
// package.json
{
  "name": "my-utils",
  "version": "1.0.0",
  "main": "dist/index.js",
  "module": "dist/index.esm.js",
  "sideEffects": false
}
```

### 라이브러리 사용자 입장

```js
// app.js
import { add } from 'my-utils';

console.log(add(1, 2));
```

이렇게 하면 `add` 함수만 번들에 포함되고, `subtract`, `formatDate`, `debounce`, `throttle` 등은 제거돼요.

## 트리셰이킹 확인하기

트리셰이킹이 제대로 작동하는지 확인하려면:

1. **프로덕션 빌드**: `npm run build` 실행
2. **번들 분석**: Webpack Bundle Analyzer 사용
3. **번들 크기 확인**: 빌드 결과물의 크기 비교

```bash
# 프로덕션 빌드
npm run build

# 번들 크기 확인
ls -lh dist/
```

## 트리셰이킹이 안 되는 경우

### 1. CommonJS 사용

```js
// ❌ 트리셰이킹 안 됨
const lodash = require('lodash');
```

### 2. 기본 임포트 사용

```js
// ❌ 전체를 가져옴
import _ from 'lodash';

// ✅ 필요한 것만 가져옴
import { debounce } from 'lodash-es';
```

### 3. 바벨 설정 문제

Babel이 ES6 모듈을 CommonJS로 변환하면 트리셰이킹이 작동하지 않아요.

```json
// .babelrc
{
  "presets": [
    [
      "@babel/preset-env",
      {
        "modules": false // ES6 모듈 구조 유지
      }
    ]
  ]
}
```

## 최적화 팁

### 1. Named Export 사용하기

```js
// ✅ 권장 (Named Export)
export function add(a, b) {
  return a + b;
}

// ❌ 비권장 (Default Export는 트리셰이킹이 어려울 수 있음)
export default {
  add: (a, b) => a + b,
  subtract: (a, b) => a - b,
};
```

### 2. lodash-es 사용하기

일반 `lodash` 대신 ES6 모듈 버전인 `lodash-es`를 사용하세요.

```js
// lodash-es는 트리셰이킹 가능
import { debounce } from 'lodash-es';
```

### 3. 라이브러리별 하위 경로 임포트

```js
// Material-UI 예시
import Button from '@mui/material/Button';
// 전체 임포트는 피하기
// import { Button } from '@mui/material';
```

```참고
usedExports vs sideEffects

웹팩에는 두 가지 트리셰이킹 관련 옵션이 있어요:

**usedExports**: 사용되는 export만 표시하고, 압축 도구(Terser)가 미사용 코드를 제거하도록 해요.

**sideEffects**: 모듈 전체를 안전하게 제거할 수 있는지 표시해요.

두 옵션을 함께 사용하면 최상의 트리셰이킹 결과를 얻을 수 있어요.
```

## 다음 단계

트리셰이킹으로 불필요한 코드를 제거했다면, 이제 번들 분석 도구로 최적화 결과를 확인해볼게요.
